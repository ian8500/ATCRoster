{% extends "base.html" %}
{% block title %}AI Rules{% endblock %}

{% block content %}
<div class="stack">
  <header class="stack">
    <h1 class="page-title">AI Rules</h1>
    <p class="muted">Fine-tune how the roster generator balances fairness, coverage, and preferences for {{ ym }}.</p>
  </header>

  <div class="card">
    <div class="card-hd"><i class="fa-solid fa-calendar-days"></i> Configuration period</div>
    <div class="card-bd">
      <form method="get" class="row g-3 align-items-end">
        <div class="col-md-4 col-lg-3">
          <label class="form-label" for="ai-rules-month">Month (YYYY-MM)</label>
          <input id="ai-rules-month" type="text" name="ym" value="{{ ym }}" class="form-control" autocomplete="off" placeholder="2024-08">
        </div>
        <div class="col-auto">
          <button class="btn btn-primary" type="submit"><i class="fa-solid fa-rotate"></i> Load month</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-hd"><i class="fa-solid fa-robot"></i> Simple editor</div>
    <div class="card-bd">
      <form method="post" class="stack">
        <input type="hidden" name="mode" value="form">

        <div class="row g-3">
          <div class="col-md-6 col-xl-4">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="respect_user_requests" name="respect_user_requests" {% if rules.respect_user_requests %}checked{% endif %}>
              <label class="form-check-label" for="respect_user_requests">Respect user requests</label>
            </div>
          </div>
          <div class="col-md-6 col-xl-4">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="equalize_nights" name="equalize_nights" {% if rules.equalize_nights %}checked{% endif %}>
              <label class="form-check-label" for="equalize_nights">Equalise nights</label>
            </div>
          </div>
          <div class="col-md-6 col-xl-4">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="nights_in_pairs" name="nights_in_pairs" {% if rules.nights_in_pairs %}checked{% endif %}>
              <label class="form-check-label" for="nights_in_pairs">Assign nights in pairs</label>
            </div>
          </div>
          <div class="col-md-6 col-xl-4">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="avoid_night_before_AL" name="avoid_night_before_AL" {% if rules.avoid_night_before_AL %}checked{% endif %}>
              <label class="form-check-label" for="avoid_night_before_AL">Avoid night before AL</label>
            </div>
          </div>
          <div class="col-md-6 col-xl-4">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="fill_short_with_D" name="fill_short_with_D" {% if rules.fill_short_with_D %}checked{% endif %}>
              <label class="form-check-label" for="fill_short_with_D">Fill shortages with Day</label>
            </div>
          </div>
          <div class="col-md-6 col-xl-4">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="nops_integrate_required" name="nops_integrate_required" {% if rules.nops_policy.integrate_required %}checked{% endif %}>
              <label class="form-check-label" for="nops_integrate_required">Integrate NOPS when required</label>
            </div>
          </div>
          <div class="col-md-6 col-xl-4">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="nops_only_if_needed" name="nops_only_if_needed" {% if rules.nops_policy.only_if_needed %}checked{% endif %}>
              <label class="form-check-label" for="nops_only_if_needed">Use NOPS only if needed</label>
            </div>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-md-6 col-xl-4">
            <label class="form-label" for="night_pool_watches">Night pool (watches CSV)</label>
            <input class="form-control" id="night_pool_watches" name="night_pool_watches" value="{{ rules.night_pool_watches|join(',') }}" placeholder="A1,B2,B3">
          </div>
          <div class="col-md-6 col-xl-4">
            <label class="form-label" for="day_weekday">Weekday Day code</label>
            <input class="form-control" id="day_weekday" name="day_weekday" value="{{ rules.day_shift_codes.weekday }}" maxlength="10">
          </div>
          <div class="col-md-6 col-xl-4">
            <label class="form-label" for="day_sunday">Sunday Day code</label>
            <input class="form-control" id="day_sunday" name="day_sunday" value="{{ rules.day_shift_codes.sunday }}" maxlength="10">
          </div>
          <div class="col-md-6 col-xl-4">
            <label class="form-label" for="no_nights_list">No-nights list (staff IDs)</label>
            <input class="form-control" id="no_nights_list" name="no_nights_list" value="{{ rules.no_nights_list|join(', ') }}" placeholder="123, 456">
          </div>
        </div>

        <div>
          <button class="btn btn-primary" type="submit"><i class="fa-solid fa-floppy-disk"></i> Save rules</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-hd"><i class="fa-solid fa-code"></i> Advanced JSON</div>
    <div class="card-bd">
      <form method="post" class="stack">
        <input type="hidden" name="mode" value="json">
        <label class="form-label" for="rules_json">Rules JSON</label>
        <textarea class="form-control font-monospace" id="rules_json" name="rules_json" rows="12">{{ rules_json }}</textarea>
        <div>
          <button class="btn btn-secondary" type="submit"><i class="fa-solid fa-floppy-disk"></i> Save JSON</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-hd"><i class="fa-solid fa-users"></i> Staff IDs (for no-nights)</div>
    <div class="card-bd">
      <ul class="simple-list">
        {% for name, sid in staff_map %}
          <li><strong>{{ name }}</strong> â€” <code>{{ sid }}</code></li>
        {% endfor %}
        {% if not staff_map %}
          <li class="muted">No staff records available.</li>
        {% endif %}
      </ul>
    </div>
  </div>
</div>
{% endblock %}
