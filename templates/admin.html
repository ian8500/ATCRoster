{% extends "base.html" %}
{% block title %}Admin{% endblock %}

{% block content %}
<div class="admin-intro">
  <h2 class="page-title">Administration</h2>
  <p class="intro-lead">Manage staffing requirements, shift definitions, and team access from one streamlined hub.</p>
  {% if current_unit %}
    <p class="text-secondary">Managing unit: <strong>{{ current_unit.name }}</strong></p>
  {% elif is_super_admin %}
    <p class="text-secondary">Managing unit: <strong>All units</strong></p>
  {% endif %}
</div>

<div class="admin-dashboard">
  <section class="admin-section">
    <header class="section-header">
      <div>
        <h3>Monthly Requirements</h3>
        <p class="section-subtitle">Tune the minimum staffing levels for each shift category across the upcoming months.</p>
      </div>
    </header>
    <form method="post" class="section-body">
      <input type="hidden" name="form" value="req">
      <table class="mini admin-table">
        <thead>
          <tr>
            <th>Month</th>
            <th>M</th>
            <th>D</th>
            <th>A</th>
            <th>N</th>
          </tr>
        </thead>
        <tbody>
          {% for y,m in months %}
            {% set r = requirements_by_month.get((y,m)) %}
            <tr>
              <td class="table-label">
                <input type="hidden" name="ym" value="{{ '%04d-%02d'|format(y,m) }}">
                {{ '%04d-%02d'|format(y,m) }}
              </td>
              <td><input type="number" name="req_m" value="{{ r.req_m if r else 0 }}" class="table-input"></td>
              <td><input type="number" name="req_d" value="{{ r.req_d if r else 0 }}" class="table-input"></td>
              <td><input type="number" name="req_a" value="{{ r.req_a if r else 0 }}" class="table-input"></td>
              <td><input type="number" name="req_n" value="{{ r.req_n if r else 0 }}" class="table-input"></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="form-actions">
        <button class="btn btn-primary" type="submit">Save Requirements</button>
      </div>
    </form>
  </section>

  <details class="admin-section admin-section--collapsible" open>
    <summary class="section-header section-header--summary">
      <div>
        <h3>Shifts</h3>
        <p class="section-subtitle">Create, update, or retire shift templates without leaving the page.</p>
      </div>
      <span class="section-toggle" aria-hidden="true">
        <i class="fa-solid fa-chevron-down"></i>
      </span>
    </summary>
    <div class="section-body stack">
      <details class="collapsible-card" open>
        <summary class="collapsible-title">Add Shift</summary>
        <form method="post" class="row inline-form">
          <input type="hidden" name="form" value="shift_new">
          <label>Code <input name="code" required class="input-sm"></label>
          <label>Name <input name="name" class="input-lg"></label>
          <label>Start <input name="start" placeholder="HH:MM" class="input-sm"></label>
          <label>End <input name="end" placeholder="HH:MM" class="input-sm"></label>
          <label class="checkbox"><input type="checkbox" name="is_working"> Working</label>
          <label class="checkbox"><input type="checkbox" name="is_training"> Training</label>
          {% if is_super_admin %}
            <label>Unit
              <select name="shift_unit_id" class="input-lg">
                <option value="global" {% if not current_unit %}selected{% endif %}>Global (all units)</option>
                {% for unit in available_units %}
                  <option value="{{ unit.id }}" {% if current_unit and unit.id == current_unit.id %}selected{% endif %}>{{ unit.name }}</option>
                {% endfor %}
              </select>
            </label>
          {% endif %}
          <button class="btn" type="submit">Add</button>
        </form>
      </details>

      <details class="collapsible-card" open>
        <summary class="collapsible-title">Existing Shifts</summary>
        <div class="table-scroll">
          <table class="mini admin-table">
            <thead>
              <tr>
                <th>Code</th>
                <th>Name</th>
                <th>Start</th>
                <th>End</th>
                <th>Working</th>
                <th>Training</th>
                <th>Unit</th>
                <th colspan="2">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for sh in shifts %}
                <tr>
                  <td>{{ sh.code }}</td>
                  <td>{{ sh.name }}</td>
                  <td>{{ sh.start_time and sh.start_time.strftime("%H:%M") or "" }}</td>
                  <td>{{ sh.end_time and sh.end_time.strftime("%H:%M") or "" }}</td>
                  <td>{{ "Yes" if sh.is_working else "No" }}</td>
                  <td>{{ "Yes" if sh.is_training else "No" }}</td>
                  <td>{{ sh.unit.name if sh.unit else 'All units' }}</td>
                  <td>
                    <form method="post" class="row inline-form inline-form--tight">
                      <input type="hidden" name="form" value="shift_edit">
                      <input type="hidden" name="shift_id" value="{{ sh.id }}">
                      <input name="name" value="{{ sh.name }}" class="input-lg">
                      <input name="start" value="{{ sh.start_time.strftime('%H:%M') if sh.start_time else '' }}" placeholder="HH:MM" class="input-sm">
                      <input name="end" value="{{ sh.end_time.strftime('%H:%M') if sh.end_time else '' }}" placeholder="HH:MM" class="input-sm">
                      <label class="checkbox"><input type="checkbox" name="is_working" {% if sh.is_working %}checked{% endif %}> W</label>
                      <label class="checkbox"><input type="checkbox" name="is_training" {% if sh.is_training %}checked{% endif %}> T</label>
                      <button class="btn" type="submit">Update</button>
                    </form>
                  </td>
                  <td class="table-actions">
                    <form method="post" onsubmit="return confirm('Delete shift {{ sh.code }}?');">
                      <input type="hidden" name="form" value="shift_delete">
                      <input type="hidden" name="shift_id" value="{{ sh.id }}">
                      <button class="btn" type="submit">Delete</button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </details>
    </div>
  </details>

  <section class="admin-section admin-section--wide">
    <header class="section-header">
      <div>
        <h3>Staff</h3>
        <p class="section-subtitle">Onboard new controllers and jump straight to profile maintenance.</p>
      </div>
    </header>
    <div class="section-body stack">
      <details class="collapsible-card" open>
        <summary class="collapsible-title">Add ATCO</summary>
        <form method="post" class="row staff-form">
          <input type="hidden" name="form" value="staff_new">
          <label>Name <input name="name" required class="input-xl"></label>
          <label>Staff # <input name="staff_no" required class="input-sm"></label>
          <label>Username <input name="username" required class="input-lg"></label>
          <label>Watch
            <select name="watch_id" required>
              <option value="">â€”</option>
              {% for w in watches %}
                <option value="{{ w.id }}">{{ w.name }}</option>
              {% endfor %}
            </select>
          </label>
          {% if is_super_admin %}
            <label>Unit
              <select name="unit_id" required>
                {% for unit in available_units %}
                  <option value="{{ unit.id }}" {% if current_unit and unit.id == current_unit.id %}selected{% endif %}>{{ unit.name }}</option>
                {% endfor %}
              </select>
            </label>
          {% endif %}
          <label>Role
            <select name="role">
              <option value="user">user</option>
              <option value="editor">editor</option>
              <option value="admin">admin</option>
              {% if is_super_admin %}
                <option value="superadmin">superadmin</option>
              {% endif %}
            </select>
          </label>

          <div class="form-divider" aria-hidden="true"></div>

          <label class="checkbox"><input type="checkbox" name="is_wm"> Watch Manager</label>
          <label class="checkbox"><input type="checkbox" name="is_dwm"> Deputy WM</label>
          <label class="checkbox"><input type="checkbox" name="exclude_from_ot"> Exclude from OT</label>

          <div class="form-divider" aria-hidden="true"></div>

          <label>Leave year start (month)
            <input type="number" name="leave_year_start_month" min="1" max="12" value="4" class="input-sm">
          </label>
          <label>Entitlement (days) <input type="number" name="leave_entitlement_days" value="25" class="input-sm"></label>
          <label>Public holidays <input type="number" name="leave_public_holidays" value="8" class="input-sm"></label>
          <label>Carryover (days) <input type="number" name="leave_carryover_days" value="0" class="input-sm"></label>

          <div class="form-actions">
            <button class="btn btn-primary" type="submit">Create ATCO</button>
          </div>
        </form>
      </details>

      <details class="collapsible-card">
        <summary class="collapsible-title">All Staff (quick links)</summary>
        <div class="table-scroll">
          <table class="mini admin-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Watch</th>
                <th>Role</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for s in staff %}
                <tr>
                  <td>{{ s.name }}</td>
                  <td>{{ s.watch.name if s.watch else '-' }}</td>
                  <td>{{ s.role }}</td>
                  <td><a class="btn" href="{{ url_for('admin_staff_edit', sid=s.id) }}">Edit</a></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </details>
    </div>
  </section>
</div>

<section class="admin-actions">
  <h3>Quick Actions</h3>
  <div class="action-buttons">
    <a class="btn" href="{{ url_for('admin_toil_new') }}">Manual TOIL Entry</a>
    <a class="btn" href="{{ url_for('admin_ai_rules') }}">AI Rules</a>
    <a class="btn" href="{{ url_for('change_log_page') }}">Change Log</a>
  </div>
</section>
{% endblock %}
